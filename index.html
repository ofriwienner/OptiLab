<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optical Table Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body class="bg-[#0a0e1a] text-gray-100 flex h-screen w-screen font-sans text-sm">

    <div id="calibration-msg" class="calibration-modal">Calibration: Click Point 1 on Image</div>
    <input type="file" id="imgUpload" accept="image/*" style="display: none;">
    <input type="file" id="fileInput" class="hidden" onchange="importState(this)">

    <!-- Sidebar -->
    <div id="ui-sidebar" class="w-72 flex-shrink-0 bg-gray-900 border-r border-gray-800 flex flex-col shadow-2xl z-10 select-none flex h-full z-50 backdrop-blur-sm bg-opacity-95">
        <div class="p-4 border-b border-gray-800 bg-gradient-to-r from-gray-900 to-gray-800">
            <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent flex items-center gap-2">
                <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                PhotonLab
            </h1>
            <p class="text-[11px] text-gray-400 mt-1">Optical Bench Simulator</p>
        </div>

        <div class="flex flex-col gap-2 p-3 border-b border-gray-800 bg-gray-900/50 text-[11px]">
            <div class="flex gap-2">
                <button onclick="newBench()" class="flex-1 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 border border-purple-500/50 rounded-lg text-white font-medium transition-all shadow-md hover:shadow-lg">New</button>
                <button onclick="saveState()" class="flex-1 py-2 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 border border-green-500 rounded-lg text-white font-medium transition-all shadow-md hover:shadow-lg">Save</button>
                <button onclick="loadState()" class="flex-1 py-2 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 border border-green-500 rounded-lg text-white font-medium transition-all shadow-md hover:shadow-lg">Load</button>
            </div>
            <div class="flex gap-2">
                <button onclick="shareTable()" class="flex-1 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 border border-purple-500/50 rounded-lg text-white font-medium transition-all shadow-md hover:shadow-lg">Share</button>
                <button onclick="exportState()" class="flex-1 py-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 border border-blue-500 rounded-lg text-white font-medium transition-all shadow-md hover:shadow-lg">Export</button>
                <label for="fileInput" class="flex-1 py-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 border border-blue-500 rounded-lg text-white font-medium transition-all shadow-md hover:shadow-lg text-center cursor-pointer">Import</label>
            </div>
        </div>

        <div class="p-3 flex-1 overflow-y-auto">
            <div class="mb-3 bg-gradient-to-br from-gray-800/80 to-gray-900/80 p-2 rounded-lg border border-gray-800 shadow-md backdrop-blur-sm">
                <h3 class="text-[10px] font-bold text-gray-300 uppercase mb-1.5 tracking-wider flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path></svg>
                    Create Board
                </h3>
                <div class="space-y-1.5">
                    <input type="text" id="boardTitle" placeholder="Title" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-2 py-1.5 text-[10px] text-white placeholder-gray-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/20 transition">
                    <select id="boardSizeSelect" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-2 py-1.5 text-[10px] text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/20 transition" onchange="updateBoardInputs()">
                        <option value="325x250">S - 12×9 (325x250)</option>
                        <option value="325x475" selected>M - 12×18 (325x475)</option>
                        <option value="475x475">L - 18×18 (475x475)</option>
                        <option value="custom">Custom</option>
                    </select>
                    <div class="flex gap-1.5">
                        <input type="number" id="boardW" value="325" step="25" class="w-1/2 bg-gray-800/50 border border-gray-700 rounded-lg px-2 py-1.5 text-[10px] text-white placeholder-gray-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/20 transition" placeholder="W">
                        <input type="number" id="boardH" value="475" step="25" class="w-1/2 bg-gray-800/50 border border-gray-700 rounded-lg px-2 py-1.5 text-[10px] text-white placeholder-gray-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/20 transition" placeholder="H">
                    </div>
                    <button onclick="addBoard()" class="w-full py-1.5 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white text-[10px] font-medium rounded-lg border border-indigo-500/50 transition-all shadow-md hover:shadow-lg hover:scale-[1.02]">Add Board</button>
                </div>
            </div>

            <div class="flex justify-between items-center mb-3">
                <h2 class="text-[11px] font-bold text-gray-300 uppercase tracking-wider flex items-center gap-2">
                    <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    Components
                </h2>
                <span class="text-[9px] text-orange-400/70 bg-orange-400/10 px-2 py-0.5 rounded-full border border-orange-400/30">Visual Only</span>
            </div>
            
            <div class="grid grid-cols-3 gap-1.5">
                <div onmousedown="startSidebarDrag(event, 'laser')" class="tool-item flex flex-col items-center p-1.5 bg-gray-800/50 rounded-lg border border-gray-700/50 text-[9px] hover:border-red-500/50">
                    <div class="icon-container"><div class="icon-laser"></div></div> <span class="mt-0.5 text-gray-300">Laser</span>
                </div>
                <div onmousedown="startSidebarDrag(event, 'mirror')" class="tool-item flex flex-col items-center p-1.5 bg-gray-800/50 rounded-lg border border-gray-700/50 text-[9px] hover:border-cyan-500/50">
                    <div class="icon-container"><div class="icon-mirror"></div></div> <span class="mt-0.5 text-gray-300">Mirror</span>
                </div>
                <div onmousedown="startSidebarDrag(event, 'mirror-d')" class="tool-item flex flex-col items-center p-1.5 bg-gray-800/50 rounded-lg border border-gray-700/50 text-[9px] hover:border-cyan-500/50">
                    <div class="icon-container"><div class="icon-mirror-d"></div></div> <span class="mt-0.5 text-gray-300">D-Mirror</span>
                </div>
                <div onmousedown="startSidebarDrag(event, 'splitter')" class="tool-item flex flex-col items-center p-1.5 bg-gray-800/50 rounded-lg border border-gray-700/50 text-[9px] hover:border-yellow-500/50">
                    <div class="icon-container"><div class="icon-splitter"></div></div> <span class="mt-0.5 text-gray-300">Splitter</span>
                </div>
                <div onmousedown="startSidebarDrag(event, 'pbs')" class="tool-item flex flex-col items-center p-1.5 bg-gray-800/50 rounded-lg border border-gray-700/50 text-[9px] hover:border-purple-500/50">
                    <div class="icon-container"><div class="icon-pbs"></div></div> <span class="mt-0.5 text-gray-300">PBS</span>
                </div>
                <div onmousedown="startSidebarDrag(event, 'aom')" class="tool-item flex flex-col items-center p-1.5 bg-gray-800/50 rounded-lg border border-gray-700/50 text-[9px] hover:border-red-500/50">
                    <div class="icon-container"><div class="icon-aom"></div></div> <span class="mt-0.5 text-gray-300">AOM</span>
                </div>
                <div onmousedown="startSidebarDrag(event, 'lens')" class="tool-item flex flex-col items-center p-1.5 bg-gray-800/50 rounded-lg border border-gray-700/50 text-[9px] hover:border-blue-500/50">
                    <div class="icon-container"><div class="icon-lens"></div></div> <span class="mt-0.5 text-gray-300">Lens</span>
                </div>
                <div onmousedown="startSidebarDrag(event, 'hwp')" class="tool-item flex flex-col items-center p-1.5 bg-gray-800/50 rounded-lg border border-gray-700/50 text-[9px] hover:border-green-500/50">
                    <div class="icon-container"><div class="icon-hwp"></div></div> <span class="mt-0.5 text-gray-300">λ/2 WP</span>
                </div>
                <div onmousedown="startSidebarDrag(event, 'qwp')" class="tool-item flex flex-col items-center p-1.5 bg-gray-800/50 rounded-lg border border-gray-700/50 text-[9px] hover:border-orange-500/50">
                    <div class="icon-container"><div class="icon-qwp"></div></div> <span class="mt-0.5 text-gray-300">λ/4 WP</span>
                </div>
                <div onmousedown="startSidebarDrag(event, 'blocker')" class="tool-item flex flex-col items-center p-1.5 bg-gray-800/50 rounded-lg border border-gray-700/50 text-[9px] hover:border-gray-500/50">
                    <div class="icon-container"><div class="icon-blocker"></div></div> <span class="mt-0.5 text-gray-300">Blocker</span>
                </div>
                <div onmousedown="startSidebarDrag(event, 'detector')" class="tool-item flex flex-col items-center p-1.5 bg-gray-800/50 rounded-lg border border-gray-700/50 text-[9px] hover:border-pink-500/50">
                    <div class="icon-container"><div class="icon-detector"></div></div> <span class="mt-0.5 text-gray-300">Detector</span>
                </div>
                <div onmousedown="startSidebarDrag(event, 'fiber-coupler')" class="tool-item flex flex-col items-center p-1.5 bg-gray-800/50 rounded-lg border border-gray-700/50 text-[9px] hover:border-orange-500/50">
                    <div class="icon-container"><div class="icon-fiber-coupler"></div></div> <span class="mt-0.5 text-gray-300">Fiber</span>
                </div>
                <div onmousedown="startSidebarDrag(event, 'amplifier')" class="tool-item flex flex-col items-center p-1.5 bg-gray-800/50 rounded-lg border border-gray-700/50 text-[9px] hover:border-red-500/50">
                    <div class="icon-container"><div class="icon-amplifier"></div></div> <span class="mt-0.5 text-gray-300">Amplifier</span>
                </div>
                <div onmousedown="startSidebarDrag(event, 'iris')" class="tool-item flex flex-col items-center p-1.5 bg-gray-800/50 rounded-lg border border-gray-700/50 text-[9px] hover:border-purple-500/50">
                    <div class="icon-container"><div class="icon-iris"></div></div> <span class="mt-0.5 text-gray-300">Iris <span class="text-orange-400">*</span></span>
                </div>
            </div>

            <h2 class="text-[11px] font-bold text-gray-300 uppercase tracking-wider mb-3 mt-6 flex items-center gap-2">
                <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                Controls
            </h2>
            <div class="bg-gradient-to-br from-gray-800/80 to-gray-900/80 rounded-xl p-3 space-y-3 border border-gray-800 shadow-lg">
                <div class="flex items-center gap-2 pb-3 border-b border-gray-800">
                    <input type="checkbox" id="showPolarizationCheckbox" checked onchange="togglePolarization(this.checked)" class="w-4 h-4 accent-blue-500 rounded border-gray-700 bg-gray-800/50 focus:ring-2 focus:ring-blue-500/20 cursor-pointer">
                    <label for="showPolarizationCheckbox" class="text-[11px] text-gray-300 cursor-pointer font-medium">Show Polarization</label>
                </div>
                <div id="controls-panel">
                    <label class="text-[11px] text-gray-400 block mb-2 font-medium">Rotation</label>
                    <div class="flex items-center gap-2">
                        <input type="range" id="rotationSlider" min="0" max="360" value="0" class="flex-1 accent-blue-500 h-2 bg-gray-800/50 rounded-lg appearance-none cursor-pointer">
                        <span id="rotationValue" class="text-[11px] w-8 text-right font-mono text-gray-300 font-semibold">0°</span>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-2">Drag white handle to rotate</p>
                    <div id="dynamic-buttons" class="mt-3 pt-3 border-t border-gray-800 space-y-2"></div>
                </div>
                
                <div class="flex gap-1">
                    <button onclick="deleteSelected()" class="flex-1 py-1 px-2 bg-red-900/50 hover:bg-red-900 text-red-200 text-[10px] rounded border border-red-800 transition">Delete</button>
                    <button onclick="clearAll()" class="flex-1 py-1 px-2 bg-gray-600 hover:bg-gray-500 text-white text-[10px] rounded border border-gray-500 transition">Clear</button>
                </div>
                <div class="flex gap-1 mt-1">
                    <button onclick="resetView()" class="flex-1 py-1 px-2 bg-blue-900/50 hover:bg-blue-900 text-blue-200 text-[10px] rounded border border-blue-800 transition">Fit Table</button>
                </div>
            </div>

            <div class="mt-4 p-2 bg-blue-900/20 border border-blue-800/50 rounded text-[10px] text-blue-200">
                <p class="font-bold mb-1">Shortcuts:</p>
                <ul class="list-disc pl-3 space-y-0.5">
                    <li><strong>Drag:</strong> Snap to Grid</li>
                    <li><strong>Shift+Drag:</strong> Fine Snap</li>
                    <li><strong>Ctrl+Drag:</strong> Free Move</li>
                    <li><strong>Dbl Click Title:</strong> Rename</li>
                    <li><strong>Shift+Click:</strong> Multi-select</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Main Canvas Area -->
    <div class="flex-1 relative bg-gray-950 overflow-hidden" id="canvas-container">
        <canvas id="opticalBench" ondragover="allowDrop(event)" ondrop="handleDrop(event)"></canvas>
        <div class="absolute bottom-4 right-4 pointer-events-none">
            <div class="bg-gray-800/90 backdrop-blur border border-gray-700 rounded p-2 text-xs text-gray-300 shadow-lg text-right">
                <div id="mouse-coords" class="font-mono text-yellow-400">X: 0mm Y: 0mm</div>
                <div id="debug-info" class="text-gray-500">Scale: 50%</div>
            </div>
        </div>
    </div>

    <!-- JavaScript Modules (load order matters) -->
    <script src="js/config.js"></script>
    <script src="js/math.js"></script>
    <script src="js/element.js"></script>
    <script src="js/physics/mueller.js"></script>
    <script src="js/physics/optics.js"></script>
    <script src="js/physics/raytracing.js"></script>
    <script src="js/renderer.js"></script>
    <script src="js/ui/calibration.js"></script>
    <!-- External libraries for Share Table feature -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/pptxgenjs@3.12.0/dist/pptxgen.min.js"></script>
    
    <script src="js/ui/controls.js"></script>
    <script src="js/ui/sidebar.js"></script>
    <script src="js/state.js"></script>
    <script src="js/input.js"></script>
    <script src="js/app.js"></script>
</body>
</html>


